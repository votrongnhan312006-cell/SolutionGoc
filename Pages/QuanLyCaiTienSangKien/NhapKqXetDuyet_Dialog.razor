@using QLCongViec.Models.SangKienCaiTien
@using Radzen
@using Radzen.Blazor
@inject DialogService DialogService
@inject ApiServices apiService
@inject NotificationService NotificationService

<RadzenCard Style="padding:30px; margin: 0 auto">

    @if (Model == null)
    {
        <div style="text-align:center; padding:20px;">
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <p>Đang tải dữ liệu...</p>
        </div>
    }
    else
    {
        <div style="text-align:center;margin-bottom:30px">
            <h3 style="font-weight:bold">PHIẾU ĐÁNH GIÁ SÁNG KIẾN (CẢI TIẾN)</h3>
            <div style="display:flex; justify-content:center; align-items:center; gap:10px">
                <h5>Năm học:</h5>
                <RadzenTextBox @bind-Value="Model.namHoc" Style="width:150px" Placeholder="2024-2025" />
            </div>
        </div>

        <div style="margin-bottom:30px">
            <h5 style="font-weight:bold;margin-bottom:15px; color:#007bff">I. Thông tin chung</h5>

            <div style="margin-bottom:20px">
                <label style="font-weight:600">1. Họ và tên cá nhân (nhóm) thực hiện sáng kiến hoặc cải tiến:</label>

                <div style="margin-top:10px;padding-left:20px; display:flex; flex-wrap:wrap; gap:10px; align-items:center">
                    <RadzenLabel Text="- Tác giả:" Style="font-weight:bold; width:100px" />
                    <RadzenTextBox @bind-Value="Model.tenTacGia" Style="flex:1; min-width:200px" Placeholder="Nhập tên tác giả" />

                    <RadzenLabel Text="Cấp bậc/CV:" Style="font-weight:bold; width:100px" />
                    <RadzenTextBox @bind-Value="Model.capBacTacGia" Style="flex:1; min-width:200px" Placeholder="Nhập cấp bậc" />
                </div>

                <div style="margin-top:10px;padding-left:20px; display:flex; flex-wrap:wrap; gap:10px; align-items:center">
                    <RadzenLabel Text="- Đồng tác giả:" Style="font-weight:bold; width:100px" />
                    <RadzenTextBox @bind-Value="Model.tenDongTacGia" Style="flex:1; min-width:200px" Placeholder="Nhập tên đồng tác giả" />

                    <RadzenLabel Text="Cấp bậc/CV:" Style="font-weight:bold; width:100px" />
                    <RadzenTextBox @bind-Value="Model.capBacDongTacGia" Style="flex:1; min-width:200px" Placeholder="Nhập cấp bậc" />
                </div>
            </div>

            <div style="margin-bottom:20px">
                <RadzenLabel Text="2. Địa điểm/Đơn vị công tác:" Style="font-weight:600;display:block;margin-bottom:5px" />
                <RadzenTextBox @bind-Value="Model.diaDiemThucHien" Style="width:100%" Placeholder="Nhập địa điểm thực hiện" />
            </div>

            <div style="margin-bottom:20px">
                <RadzenLabel Text="3. Tên sáng kiến hoặc cải tiến:" Style="font-weight:600;display:block;margin-bottom:5px" />
                <RadzenTextBox @bind-Value="Model.tenSangKienCaiTien" Style="width:100%" Placeholder="Nhập tên sáng kiến hoặc cải tiến" />
            </div>
        </div>

        <div style="margin-bottom:30px">
            <h5 style="font-weight:bold;margin-bottom:15px; color:#007bff">II. Ý kiến đánh giá của đơn vị</h5>

            <div style="margin-bottom:20px">
                <RadzenLabel Text="1. Mô tả nội dung/Hiệu quả" Style="font-weight:600;display:block;margin-bottom:5px" />
                <RadzenTextArea @bind-Value="Model.moTa" Rows="4" Style="width:100%" Placeholder="Nhập mô tả chi tiết..." />
            </div>

            <div style="margin-bottom:20px">
                <RadzenLabel Text="2. Kết quả đạt được" Style="font-weight:600;display:block;margin-bottom:5px" />
                <RadzenTextArea @bind-Value="Model.ketQua" Rows="4" Style="width:100%" Placeholder="Nhập kết quả thực tế..." />
            </div>

            <div style="margin-bottom:20px">
                <RadzenLabel Text="3. Phạm vi thực hiện" Style="font-weight:600;display:block;margin-bottom:5px" />
                <RadzenTextBox @bind-Value="Model.phamViThucHien" Style="width:100%" Placeholder="Nhập phạm vi áp dụng..." />
            </div>
        </div>

        <div style="margin-top:40px;text-align:center;display:flex;gap:15px;justify-content:center">
            <RadzenButton Text="Lưu kết quả" Icon="save" ButtonStyle="ButtonStyle.Primary" Click="@Luu" Style="width:150px" IsBusy="@isBusy" />
            <RadzenButton Text="Đóng" Icon="cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => DialogService.Close(false))" Style="width:150px" Disabled="@isBusy" />
        </div>
    }

</RadzenCard>

@inject ApiServices apiService
@code {
    // Nhận ID từ trang cha
    [Parameter] public int idSangKienCaiTien { get; set; }

    private tbSangKienCaiTien? Model;
    private bool isBusy = false;

    protected override async Task OnInitializedAsync()
    {
        // ta gọi GetAll rồi lọc (vì ApiServices của bạn chưa có GetById)
        var listData = await apiService.GetAll<tbSangKienCaiTien>();

        // Tìm bản ghi có id khớp với tham số truyền vào
        Model = listData?.FirstOrDefault(x => x.idSangKienCaiTien == idSangKienCaiTien);

        // Nếu không tìm thấy hoặc null, khởi tạo mới
        if (Model == null) Model = new tbSangKienCaiTien();
    }

    private async Task Luu()
    {
        if (Model == null) return;

        try
        {
            await apiService.Update<tbSangKienCaiTien>(Model);
            isBusy = true;

            DialogService.Close(true);

            // Nếu muốn gọi API Update thật sự, bạn cần bổ sung hàm Update vào ApiServices (xem Cách 2)
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Lỗi", Detail = "Có lỗi xảy ra: " + ex.Message });
        }
        finally
        {
            isBusy = false;
        }
    }
}