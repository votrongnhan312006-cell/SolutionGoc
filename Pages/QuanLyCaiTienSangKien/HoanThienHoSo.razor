@page "/HoanThienHoSoSkct"
@using Radzen
@using Radzen.Blazor
@using QLCongViec.Models.SangKienCaiTien

@inject DialogService DialogService
@inject NotificationService NotificationService
<style>
    /* ===== CARD ===== */
    .skct-card {
        border-radius: 16px;
        background: #ffffff;
        box-shadow: 0 10px 30px rgba(0,0,0,.08);
        border: 1px solid #e5e7eb;
    }

    /* ===== HEADER ===== */
    .skct-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 14px;
        margin-bottom: 18px;
        border-bottom: 1px solid #e5e7eb;
    }

        .skct-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
            margin: 0;
        }

        .skct-header p {
            font-size: 14px;
            color: #64748b;
            margin: 6px 0 0;
        }

    /* ===== GRID ===== */
    .skct-grid {
        border-radius: 12px;
        overflow: hidden;
        font-size: 14px;
    }

        .skct-grid .rz-datatable-thead th {
            background: #f1f5f9;
            color: #334155;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
        }

        .skct-grid .rz-datatable-row {
            transition: background-color .15s ease;
        }

            .skct-grid .rz-datatable-row:hover {
                background-color: #f8fafc;
            }

    /* ===== SÁNG KIẾN ===== */
    .skct-title {
        font-weight: 600;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .skct-desc {
        font-size: 13px;
        color: #64748b;
        margin-left: 26px;
        margin-top: 4px;
    }

    /* ===== THIẾU HỒ SƠ ===== */
    .skct-missing {
        background: #fff7ed;
        border-left: 4px solid #fb923c;
        padding: 6px 8px;
        border-radius: 6px;
    }

    .skct-warning {
        color: #dc2626;
        font-size: 18px;
    }

    /* ===== BUTTON ===== */
    .skct-action-btn {
        border-radius: 10px;
        font-weight: 500;
    }

    /* ===== BADGE ===== */
    .skct-status {
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 999px;
    }
    /* ===== BADGE ĐƯỢC PHÊ DUYỆT (Y HÌNH) ===== */
    .skct-status-approved {
        display: inline-flex !important;
        align-items: center;
        gap: 6px;
        padding: 6px 16px;
        min-width: 150px;
        justify-content: center;
        border-radius: 999px !important;
        background-color: #eafaf1 !important;
        color: #15803d !important;
        font-size: 13px;
        font-weight: 500;
        line-height: 1;
        white-space: nowrap;
    }

        /* ICON ✓ — ÉP HIỂN THỊ */
        .skct-status-approved .rz-icon {
            display: inline-flex !important;
            font-size: 16px;
            color: #16a34a !important;
            opacity: 1 !important;
        }
</style>

<RadzenCard Class="skct-card" Style="padding:20px">

    <div class="skct-header">
        <div>
            <h3>Danh sách sáng kiến cải tiến</h3>
            <p>Danh mục sáng kiến đã được Hội đồng phê duyệt</p>
        </div>

    </div>

    <RadzenDataGrid Data="@dsSangKienDaDuyet"
                    TItem="tbSangKienCaiTien"
                    Class="skct-grid"
                    AllowPaging="true"
                    PageSize="10">

        <Columns>

            <!-- STT -->
            <RadzenDataGridColumn Title="STT" Width="70px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    @(dsSangKienDaDuyet.IndexOf(item) + 1)
                </Template>
            </RadzenDataGridColumn>

            <!-- TÊN SÁNG KIẾN -->
            <RadzenDataGridColumn Title="Tên sáng kiến cải tiến" Width="320px">
                <Template Context="item">
                    <div class="skct-title @(CanhBaoThieuHoSo(item) ? "skct-missing" : "")">
                        @if (CanhBaoThieuHoSo(item))
                        {
                            <RadzenIcon Icon="error"
                                        Class="skct-warning" />
                        }
                        <span>@item.tenSangKienCaiTien</span>
                    </div>

                    @if (!string.IsNullOrEmpty(item.moTa))
                    {
                        <div class="skct-desc">
                            @item.moTa
                        </div>
                    }
                </Template>
            </RadzenDataGridColumn>

            <!-- CẤP -->
            <RadzenDataGridColumn Title="Cấp" Width="120px">
                <Template Context="item">
                    Học viện
                </Template>
            </RadzenDataGridColumn>

            <!-- TÁC GIẢ -->
            <RadzenDataGridColumn Title="Tác giả" Width="200px">
                <Template Context="item">
                    <div style="font-weight:600;color:#0f172a">
                        @item.tenTacGia
                    </div>
                    <div style="font-size:13px;color:#64748b">
                        @item.capBacTacGia
                    </div>
                </Template>
            </RadzenDataGridColumn>

            <!-- NGÀY -->
            <RadzenDataGridColumn Title="Ngày thực hiện" Width="130px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    @item.ngayThucHien?.ToString("dd/MM/yyyy")
                </Template>
            </RadzenDataGridColumn>

            <!-- TRẠNG THÁI -->
            <RadzenDataGridColumn Title="Trạng thái" Width="190px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    <div class="skct-status-approved">
                        <RadzenIcon Icon="check_circle" />
                        <span>Được phê duyệt</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>

            <!-- THAO TÁC -->
            <RadzenDataGridColumn Title="Thao tác" Width="160px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    <RadzenStack Orientation="Orientation.Horizontal"
                                 JustifyContent="JustifyContent.Center"
                                 Gap="6px">

                        <RadzenButton Icon="assignment"
                                      Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Variant="Variant.Outlined"
                                      Class="skct-action-btn"
                                      Title="Xử lý – hoàn thiện hồ sơ"
                                      Click="@(() => XuLyHoanThienHoSo(item))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>

        </Columns>
    </RadzenDataGrid>
</RadzenCard>

@code {

    List<tbSangKienCaiTien> dsSangKienDaDuyet = new();

    protected override void OnInitialized()
    {
        dsSangKienDaDuyet = new()
        {
            new tbSangKienCaiTien
            {
                idSangKienCaiTien = 1,
                tenSangKienCaiTien = "Ứng dụng CNTT trong quản lý",
                moTa = "Sáng kiến phục vụ công tác quản lý",
                tenTacGia = "Nguyễn Văn A",
                capBacTacGia = "Đại úy",
                ngayThucHien = DateOnly.FromDateTime(DateTime.Now.AddDays(-10)),
                idCap = 1,
                idTrangThai = 1,
                fileDangKy = null,
                fileKetQua = null
            },
            new tbSangKienCaiTien
            {
                idSangKienCaiTien = 2,
                tenSangKienCaiTien = "Cải tiến quy trình nghiệp vụ",
                moTa = "Nâng cao hiệu quả xử lý hồ sơ",
                tenTacGia = "Trần Văn B",
                capBacTacGia = "Thượng úy",
                ngayThucHien = DateOnly.FromDateTime(DateTime.Now.AddDays(-20)),
                idCap = 2,
                idTrangThai = 1,
                fileDangKy = "dk.pdf",
                fileKetQua = null
            }
        };
    }

    bool CanhBaoThieuHoSo(tbSangKienCaiTien sk)
        => string.IsNullOrEmpty(sk.fileKetQua);


    async Task XuLyHoanThienHoSo(tbSangKienCaiTien sk)
    {
        await DialogService.OpenAsync<ChiTietDeXuat_Dialog>(
            "Hoàn thiện hồ sơ",
            new Dictionary<string, object>
            {
            { "SelectedGTTL", sk }
            }
        );
    }


}
