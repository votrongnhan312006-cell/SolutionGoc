@page "/NhapKqXetDuyet"
@using QLCongViec.Models.SangKienCaiTien
@using Radzen
@using Radzen.Blazor
@inject ApiServices apiService
@inject Radzen.DialogService DialogService

<RadzenCard Style="padding:20px">
    <h3>Danh sách đề xuất của đơn vị</h3>
    <p style="color:#6c757d;margin-bottom:20px">Theo dõi trạng thái các đề xuất biên soạn đã gửi</p>

    <RadzenDataGrid Data="@lstSangKienCaiTien"
                    TItem="tbSangKienCaiTien"
                    AllowPaging="true"
                    PageSize="10"
                    EmptyText="Không có dữ liệu">

        <Columns>
            <RadzenDataGridColumn Title="STT" Width="100px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    @(lstSangKienCaiTien != null ? lstSangKienCaiTien.IndexOf(item) + 1 : 0)
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="tbSangKienCaiTien" Property="tenSangKienCaiTien" Title="Tên sáng kiến cải tiến" Width="300px">
                <Template Context="item">
                    <div style="display:flex; align-items:flex-start">
                        <strong>@item.tenSangKienCaiTien</strong>
                    </div>

                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="tbSangKienCaiTien" Property="namHoc" Title="Năm học" Width="120px" TextAlign="TextAlign.Center" />
            <RadzenDataGridColumn TItem="tbSangKienCaiTien" Property="tenTacGia" Title="Tác giả" Width="180px" />

            <RadzenDataGridColumn Title="Ngày thực hiện" Width="150px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    @item.ngayThucHien?.ToString("dd/MM/yyyy")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="tbSangKienCaiTien" Title="Trạng thái" Width="160px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    @if (item.idTrangThai == 1)
                    {
                        <RadzenBadge Text="Được phê duyệt" BadgeStyle="BadgeStyle.Success" Style="padding:8px 12px" />
                    }
                    else if (item.idTrangThai == 2 || item.idTrangThai == 0 || item.idTrangThai == null)
                    {
                        <RadzenBadge Text="Chờ xét duyệt" BadgeStyle="BadgeStyle.Warning" Style="padding:8px 12px" />
                    }
                    else
                    {
                        <RadzenBadge Text="Không phê duyệt" BadgeStyle="BadgeStyle.Danger" Style="padding:8px 12px" />
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Title="Thao tác" Width="140px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    <div style="display:flex;gap:5px;justify-content:center">
                        <RadzenButton Icon="visibility" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined"
                                      Click="@(() => XemChiTiet(item.idSangKienCaiTien))" title="Chi tiết" />

                        <RadzenButton Icon="assignment_turned_in" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined"
                                      Click="@(() => CapNhatKetQua(item.idSangKienCaiTien))" title="Cập nhật kết quả" />
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenCard>

@code {
    private List<tbSangKienCaiTien>? lstSangKienCaiTien;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        // Giả định API trả về danh sách
        lstSangKienCaiTien = await apiService.GetAll<tbSangKienCaiTien>();
    }

    private async Task XemChiTiet(int id)
    {
        await DialogService.OpenAsync<ChiTietDeXuat_Dialog>(
            "Chi tiết sáng kiến",
            new Dictionary<string, object> { ["Id"] = (long)id }, // Ép kiểu int sang long ở đây
            new Radzen.DialogOptions
            {
                Width = "900px",
                Height = "700px",
                Resizable = true,
                Draggable = true
            }
        );
    }

    private async Task CapNhatKetQua(int id)
    {
        // Mở Dialog và truyền tham số idSangKienCaiTien
        var result = await DialogService.OpenAsync<NhapKqXetDuyet_Dialog>(
            "Nhập kết quả xét duyệt",
            new Dictionary<string, object> { ["idSangKienCaiTien"] = id },
            new Radzen.DialogOptions
            {
                Width = "900px", // Tăng độ rộng cho dễ nhìn
                Height = "auto",
                CloseDialogOnOverlayClick = false
            }
        );

        // Nếu Dialog trả về true (đã lưu thành công), tải lại dữ liệu
        if (result is bool && (bool)result)
        {
            await LoadData();
            // Có thể thêm thông báo thành công ở đây (NotificationService)
        }
    }
}