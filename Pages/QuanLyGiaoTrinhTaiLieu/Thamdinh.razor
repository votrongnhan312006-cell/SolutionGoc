@page "/thamdinhgt"
@using Radzen
@using Radzen.Blazor
@using api.Models.QLBienSoan
@inject DialogService DialogService

<style>
    /* Style cho danh sách đề tài bên trái */
    .item-card {
        border: 1px solid #ddd;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 8px;
    }

        .item-card:hover {
            background-color: #f8f9fa;
        }

    .item-card-selected {
        border: 2px solid #4A90E2 !important;
        background-color: #f0f7ff !important;
    }

    /* Style cho vùng Upload file giống Mockup */
    .custom-upload-box .rz-fileupload-buttonbar {
        display: none !important;
    }

    .custom-upload-box .rz-fileupload-content {
        border: 2px dashed #ccc !important;
        border-radius: 8px !important;
        background: #fafafa !important;
        cursor: pointer;
        padding: 20px !important;
    }

        .custom-upload-box .rz-fileupload-content:hover {
            border-color: #4A90E2 !important;
            background: #f0f7ff !important;
        }

    /* Tùy chỉnh danh sách kết luận */
    .conclusion-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        width: 100%;
        display: flex;
        align-items: center;
    }
</style>

<div class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Weight="FontWeight.Bold">Quản lý thẩm định nội dung</RadzenText>
    <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-mb-6">Cập nhật kết quả thẩm định từ Hội đồng</RadzenText>

    <RadzenRow Gap="1.5rem">
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenStack Gap="12px">
                @foreach (var item in lstGTTL)
                {
                    <RadzenCard @onclick="@(() => selectedGTTL = item)"
                                Class="@(selectedGTTL?.idGTTL == item.idGTTL ? "item-card item-card-selected rz-p-3" : "item-card rz-p-3")">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                            <RadzenStack Gap="4px" Style="width: 75%;">
                                <RadzenText TextStyle="TextStyle.Subtitle2" Weight="FontWeight.Bold" Class="rz-mb-0">@item.tenGTTL</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-mb-0">@item.chuBien</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-mb-0">@GetTenDonVi(item.idDonVi)</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Nộp: @item.ngayGuiDeXuat?.ToString("dd/MM/yyyy")</RadzenText>
                            </RadzenStack>
                            <RadzenBadge BadgeStyle="@GetBadgeStyle(item.idTinhTrang)" Text="@GetTrangThai(item.idTinhTrang)" IsPill="true" />
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="8">
            @if (selectedGTTL != null)
            {
                <RadzenCard Variant="Variant.Outlined" Class="rz-p-5">
                    <RadzenText TextStyle="TextStyle.H6" Weight="FontWeight.Bold">Thông tin đề tài</RadzenText>
                    <hr class="rz-mb-4" />

                    <RadzenRow Class="rz-mb-6">
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Mã tài liệu</RadzenText>
                            <RadzenText Class="rz-mb-4">@selectedGTTL.maTaiLieu</RadzenText>

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Tên giáo trình/tài liệu</RadzenText>
                            <RadzenText Class="rz-mb-4">@selectedGTTL.tenGTTL</RadzenText>

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Đơn vị</RadzenText>
                            <RadzenText>@GetTenDonVi(selectedGTTL.idDonVi)</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Trạng thái</RadzenText>
                            <RadzenBadge BadgeStyle="@GetBadgeStyle(selectedGTTL.idTinhTrang)" Text="@GetTrangThai(selectedGTTL.idTinhTrang)" Class="rz-mb-4" />

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Chủ biên</RadzenText>
                            <RadzenText Class="rz-mb-4">@selectedGTTL.chuBien</RadzenText>

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Ngày gửi đề xuất</RadzenText>
                            <RadzenText>@selectedGTTL.ngayGuiDeXuat?.ToString("dd/MM/yyyy")</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Bản thảo</RadzenText>
                    <RadzenStack Orientation="Orientation.Vertical" Gap="8px" Class="rz-mb-6">
                        @if (!string.IsNullOrEmpty(selectedGTTL.fileBanThao))
                        {
                            <RadzenLink Path="#" Icon="description">@selectedGTTL.fileBanThao</RadzenLink>
                        }
                        @if (!string.IsNullOrEmpty(selectedGTTL.fileDeCuongChiTiet))
                        {
                            <RadzenLink Path="#" Icon="description">@selectedGTTL.fileDeCuongChiTiet</RadzenLink>
                        }
                        @if (string.IsNullOrEmpty(selectedGTTL.fileBanThao) && string.IsNullOrEmpty(selectedGTTL.fileDeCuongChiTiet))
                        {
                            <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">Chưa có file bản thảo</RadzenText>
                        }
                    </RadzenStack>

                    <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Hội đồng thẩm định</RadzenText>

                    @if (selectedGTTL.idTinhTrang == 3)
                    {
                        <RadzenAlert Title="Kết quả thẩm định" AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true">
                            <RadzenText TextStyle="TextStyle.Body2"><b>@GetTrangThai(selectedGTTL.idTinhTrang)</b> - Ngày thẩm định: @selectedGTTL.ngayThamDinh?.ToString("dd/MM/yyyy")</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@(string.IsNullOrEmpty(selectedGTTL.ghiChu) ? "Nội dung đầy đủ, cấu trúc logic, đạt yêu cầu đề ra." : selectedGTTL.ghiChu)</RadzenText>
                        </RadzenAlert>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true" Class="rz-mb-4">
                            Sau khi Hội đồng họp xong, vui lòng nhập kết quả thẩm định và đính kèm biên bản.
                        </RadzenAlert>
                        <RadzenButton Text="Nhập kết quả thẩm định" Icon="edit"
                                      ButtonStyle="ButtonStyle.Primary" Class="rz-w-100 rz-mt-2"
                                      Style="height: 45px; font-size: 16px;"
                                      Click="@ShowInputResultDialog" />
                    }
                </RadzenCard>
            }
        </RadzenColumn>
    </RadzenRow>
</div>

@code {
    List<tbGTTL> lstGTTL = new();
    tbGTTL? selectedGTTL;
    InputResultModel resultForm = new();

    protected override async Task OnInitializedAsync()
    {
        // TODO: await LoadGTTLList();
        lstGTTL = new List<tbGTTL>();
    }

    BadgeStyle GetBadgeStyle(byte status) => status switch
    {
        1 => BadgeStyle.Warning,
        2 => BadgeStyle.Info,
        3 => BadgeStyle.Success,
        4 => BadgeStyle.Danger,
        5 => BadgeStyle.Secondary,
        _ => BadgeStyle.Secondary
    };

    string GetTrangThai(byte status) => status switch
    {
        1 => "Chờ thẩm định",
        2 => "Đang thẩm định",
        3 => "Đạt",
        4 => "Không đạt",
        5 => "Cần chỉnh sửa",
        _ => "Không xác định"
    };

    string GetTenDonVi(int? idDonVi)
    {
        // TODO: Gọi API hoặc từ cache để lấy tên đơn vị
        return idDonVi switch
        {
            1 => "Khoa Cơ khí",
            2 => "Khoa Điện",
            3 => "Khoa CNTT",
            4 => "Khoa Kinh tế",
            _ => "Chưa xác định"
        };
    }

    async Task ShowInputResultDialog()
    {
        if (selectedGTTL == null) return;

        resultForm = new InputResultModel();

        var dialogResult = await DialogService.OpenAsync("Cập nhật kết quả", ds =>
            @<RadzenStack Gap="1.2rem" Class="rz-p-2">
    <RadzenStack Gap="0">
        <RadzenText TextStyle="TextStyle.H6" Weight="FontWeight.Bold" Class="rz-mb-0">Nhập kết quả thẩm định</RadzenText>
        <RadzenText TextStyle="TextStyle.Caption">@selectedGTTL?.tenGTTL</RadzenText>
    </RadzenStack>

    <hr class="rz-m-0" />

    <div>
        <RadzenLabel Text="Ngày thẩm định *" Style="font-weight: bold; font-size: 13px;" />
        <RadzenDatePicker @bind-Value="@resultForm.NgayThamDinh" Style="width: 100%;" DateFormat="dd/MM/yyyy" Placeholder="dd/mm/yyyy" />
    </div>

    <div>
        <RadzenLabel Text="Kết luận *" Style="font-weight: bold; font-size: 13px;" />
        <RadzenRadioButtonList @bind-Value="@resultForm.KetLuan" TValue="byte" Orientation="Orientation.Vertical" Class="rz-w-100">
            <Items>
                <RadzenRadioButtonListItem Text="Đạt" Value="@((byte)3)" />
                <RadzenRadioButtonListItem Text="Cần chỉnh sửa" Value="@((byte)5)" />
                <RadzenRadioButtonListItem Text="Không đạt" Value="@((byte)4)" />
            </Items>
        </RadzenRadioButtonList>
    </div>

    <div>
        <RadzenLabel Text="Nhận xét" Style="font-weight: bold; font-size: 13px;" />
        <RadzenTextArea @bind-Value="@resultForm.NhanXet" Placeholder="Nhận xét chung về tài liệu..." Style="width: 100%;" Rows="3" />
    </div>

    <div>
        <RadzenLabel Text="Biên bản thẩm định *" Style="font-weight: bold; font-size: 13px;" />
        <RadzenUpload Url="upload/single" Class="custom-upload-box" Multiple="false">
            <ChildContent>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-p-4">
                    <RadzenIcon Icon="cloud_upload" Style="font-size: 30px; color: #aaa;" />
                    <RadzenText TextStyle="TextStyle.Caption" Class="rz-mb-0">Tải lên biên bản thẩm định</RadzenText>
                    <RadzenText TextStyle="TextStyle.Overline">PDF, DOC, DOCX (tối đa 10MB)</RadzenText>
                </RadzenStack>
            </ChildContent>
        </RadzenUpload>
    </div>

    <div>
        <RadzenLabel Text="Phiếu nhận xét (tùy chọn)" Style="font-weight: bold; font-size: 13px;" />
        <RadzenUpload Url="upload/multiple" Class="custom-upload-box" Multiple="true">
            <ChildContent>
                <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem" Class="rz-p-4">
                    <RadzenIcon Icon="cloud_upload" Style="font-size: 30px; color: #aaa;" />
                    <RadzenText TextStyle="TextStyle.Caption" Class="rz-mb-0">Tải lên các phiếu nhận xét</RadzenText>
                </RadzenStack>
            </ChildContent>
        </RadzenUpload>
    </div>

    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="10px" Class="rz-mt-4">
        <RadzenButton Text="Hủy" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" Style="min-width: 80px;" />
        <RadzenButton Text="Lưu kết quả" Click="() => ds.Close(true)" ButtonStyle="ButtonStyle.Primary" Style="min-width: 120px;" />
    </RadzenStack>
</RadzenStack>
        , new DialogOptions() { Width = "580px", Resizable = false, Draggable = true });

        if (dialogResult == true && selectedGTTL != null)
        {
            selectedGTTL.idTinhTrang = resultForm.KetLuan;
            selectedGTTL.ngayThamDinh = DateOnly.FromDateTime(resultForm.NgayThamDinh ?? DateTime.Now);
            selectedGTTL.ghiChu = resultForm.NhanXet;

            // TODO: await SaveThamDinhResult(selectedGTTL);
            StateHasChanged();
        }
    }

    public class InputResultModel
    {
        public DateTime? NgayThamDinh { get; set; } = DateTime.Now;
        public byte KetLuan { get; set; } = 3;
        public string NhanXet { get; set; } = "";
    }
}
