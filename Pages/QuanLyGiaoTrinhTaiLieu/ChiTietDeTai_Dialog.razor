@using QLCongViec.Models.QLBienSoan
@using Radzen
@using Radzen.Blazor
@using api.Models.QLBienSoan
@inject DialogService DialogService
@inject ApiServices apiService

<style>

    /* Card tiến độ */
    .tiendo-card {
        background: #fff;
        border-radius: 8px;
        padding: 14px 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
    }

    /* Header */
    .tiendo-header {
        margin-bottom: 10px;
    }

    .tiendo-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
    }

    /* Body */
    .tiendo-body {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
    }

    .tiendo-col .label {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 4px;
    }

    .tiendo-col .value {
        font-weight: 500;
    }

    /* Trạng thái text */
    .status-text {
        font-weight: 600;
    }

    /* Màu theo trạng thái */
    .tiendo-latedone {
        background: #fff7ed;
        border-color: #fdba74;
    }

    .tiendo-done {
        background: #D8F3CD;
        border-color: #08A045;
    }

    .tiendo-overdue {
        background: #fef2f2;
        border-color: #fecaca;
    }

    .tiendo-pending {
        background: #f9fafb;
    }

    /* Text màu */
    .text-latedone {
        color: #ea580c;
    }

    .text-done {
        color: #08A045;
    }

    .text-overdue {
        color: #dc2626;
    }

    .text-pending {
        color: #6b7280;
    }

    /* Icon */
    .icon-done {
        color: #f97316;
    }

    .icon-overdue {
        color: #dc2626;
    }

    .icon-pending {
        color: #9ca3af;
    }

</style>

<RadzenCard Style="padding:20px;max-height:80vh;overflow:auto">

    <h4 style="font-weight:600;margin-bottom:16px">
        @Model.TenGTTL
    </h4>

    <RadzenTabs>
        <Tabs>

            <!-- TAB 1: TỔNG QUAN -->
            <RadzenTabsItem Text="Tổng quan">
                <RadzenCard Style="margin-bottom:10px;padding:16px;background:#f9f9f9">
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Mã tài liệu</div><div class="col-8">@Model.MaTaiLieu</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Tên đề tài</div><div class="col-8">@Model.TenGTTL</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Chủ biên</div><div class="col-8">@Model.ChuBien</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Thành viên</div><div class="col-8">@Model.ThanhVien</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Môn học</div><div class="col-8">@Model.IdMonHoc</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Số tín chỉ</div><div class="col-8">@Model.SoTinChi</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Đơn vị chủ trì</div><div class="col-8">@Model.IdDonVi</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Ngày giao nhiệm vụ</div><div class="col-8">@Model.NgayGiaoNV?.ToString("dd/MM/yyyy")</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Hạn hoàn thành</div><div class="col-8">@Model.HanHoanThanh?.ToString("dd/MM/yyyy")</div></div>
                    <div class="row mb-2"><div class="col-4 font-weight-bold">Trạng thái</div><div class="col-8">@Model.IdTinhTrang</div></div>
                    <div class="row"><div class="col-4 font-weight-bold">Ghi chú</div><div class="col-8">@Model.GhiChu</div></div>
                </RadzenCard>
            </RadzenTabsItem>

            <!-- TAB 2: TIẾN ĐỘ -->
            <RadzenTabsItem Text="Tiến độ">
                <RadzenCard Style="padding:16px;background:#f9f9f9">

                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                        <h5 style="font-weight:600">Cập nhật tiến độ công việc</h5>
                        @* <span style="color:#6c757d;font-size:14px">
                            Hoàn thành: @($"{lstTienDo.Count(x => x.TrangThai == 3)}/{lstTienDo.Count}")
                        </span> *@
                    </div>

                    @foreach (var item in lstTienDo)
                    {
                        <div class="tiendo-card @GetTienDoClass(item)">

                            <!-- Hàng trên: Icon + Tên -->
                            <div class="tiendo-header">
                                <div class="tiendo-title">
                                    <i class="@GetTienDoIcon(item)"></i>
                                    <span>@item.tenTienDo</span>
                                </div>
                            </div>

                            <!-- Hàng dưới: Thông tin -->
                            <div class="tiendo-body">

                                <div class="tiendo-col">
                                    <div class="label">Ngày dự kiến</div>
                                    <div class="value">@item.ngayDuKien?.ToString("dd/MM/yyyy")</div>
                                </div>

                                <div class="tiendo-col">
                                    <div class="label">Ngày hoàn thành thực tế</div>
                                    <RadzenDatePicker @bind-Value="item.ngayHoanThanhThucTe"
                                                      DateFormat="dd/MM/yyyy"
                                                      Style="width:160px" />
                                </div>

                                <div class="tiendo-col">
                                    <div class="label">Trạng thái</div>
                                    <div class="status-text @GetTrangThaiTextClass(item)">
                                        @lstTrangThai?.FirstOrDefault(x => x.idTinhTrangDeTai == item.idTrangThai)?.tenTinhTrangDeTai
                                    </div>
                                </div>

                            </div>
                        </div>
                    }

                </RadzenCard>
            </RadzenTabsItem>


            <!-- TAB 3: TÀI LIỆU -->
            <RadzenTabsItem Text="Tài liệu">
                <!-- File -->
                <div class="row" style="margin-bottom: 16px;">
                    <div class="col-md-12">
                        <RadzenLabel Text="File tải lên" Component="FileQD" Style="margin-bottom: 8px; display: block;" />
                        <div style="border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; background-color: #fafafa;">
                            <div style="font-size: 48px; margin-bottom: 12px;">📤</div>
                            <div style="color: #666; margin-bottom: 8px;">Tải lên file</div>
                            <div style="color: #999; font-size: 12px;">PDF, DOC, DOCX (tối đa 10MB)</div>
                        </div>
                    </div>
                </div>
            </RadzenTabsItem>

        </Tabs>
    </RadzenTabs>

    <RadzenButton Text="Đóng"
                  Style="width:100%;margin-top:20px"
                  ButtonStyle="ButtonStyle.Dark"
                  Click="@(() => DialogService.Close())" />
</RadzenCard>


@inject ApiServices apiService
@code {
    [Parameter] public tbGTTL Model { get; set; }
    private List<tbGTTL> lstGTTL = new();
    private List<tbTienDo> lstTienDo = new();
    private List<tbTrangThai> lstTrangThai = new();
    protected override async Task OnInitializedAsync()
    {
        lstTienDo = await apiService.GetAll<tbTienDo>();
        lstTrangThai = await apiService.GetAll<tbTrangThai>();
    }



    // =========================
    // TÀI LIỆU (UPLOAD)
    // =========================
    private string GetUploadUrl(int idGttl) => $"api/upload/gttl/{idGttl}";

    void OnUploadProgress(UploadProgressArgs args)
    {
        // Có thể hiển thị tiến trình nếu cần
    }

    void OnUploadComplete(UploadCompleteEventArgs args)
    {
        // Sau khi upload xong có thể gọi API để lưu thông tin file
        StateHasChanged();
    }

    private async Task DownloadFile(string? filePath)
    {
        if (!string.IsNullOrEmpty(filePath))
        {
            // gọi API để lấy dữ liệu
            lstGTTL = await apiService.GetAll<tbGTTL>();
        }
    }

    // string GetTrangThaiText(tbTienDo item)
    // {
    //     idTrangThai = 3 = Chưa hoàn thành
    //     if (item.ngayDuKien > DateOnly.FromDateTime(DateTime.Today) && item.ngayHoanThanhThucTe == null)
    //     {
    //         item.idTrangThai = 3;
    //         return "Chưa hoàn thành";
    //     }
    //     idTrangThai = 4 = Hoàn thành trễ
    //     if (item.ngayHoanThanhThucTe > item.ngayDuKien)
    //     {
    //         item.idTrangThai = 4;
    //         return "Hoàn thành trễ";
    //     }
    //     idTrangThai = 6 = Hoàn thành
    //     if (item.ngayHoanThanhThucTe < item.ngayDuKien)
    //     {
    //         item.idTrangThai = 6;
    //         return "Hoàn thành";
    //     }
    //     idTrangThai = 5 = Quá hạn
    //     item.idTrangThai = 5;
    //     return "Quá hạn";
    // }

    string GetTrangThaiTextClass(tbTienDo item)
    {
        //Hoàn thành trễ
        if (item.idTrangThai == 4) return "text-latedone";
        //Quá hạn
        if (item.idTrangThai == 5) return "text-overdue";
        //Hoàn thành
        if (item.idTrangThai == 6) return "text-done";
        //Chưa hoàn thành
        return "text-pending";
    }

    string GetTienDoClass(tbTienDo item)
    {
        //Hoàn thành trễ
        if (item.idTrangThai == 4) return "tiendo-latedone";
        //Quá hạn
        if (item.idTrangThai == 5) return "tiendo-overdue";
        //Hoàn thành
        if (item.idTrangThai == 6) return "tiendo-done";
        //Chưa hoàn thành
        return "tiendo-pending";
    }

    string GetTienDoIcon(tbTienDo item)
    {
        //Hoàn thành trễ
        if (item.idTrangThai == 4) return "rz-icon rz-check-circle icon-done";
        //Quá hạn
        if (item.idTrangThai == 5) return "rz-icon rz-alert-circle icon-overdue";
        //Chưa hoàn thành
        return "rz-icon rz-clock icon-pending";
    }


}
