@page "/DuyetKeHoachDuToan"
@using Radzen
@using Radzen.Blazor
@using api.Models.QLBienSoan
@inject ApiServices apiService

<RadzenCard Class="rz-m-4 rz-p-0">

    <!-- HEADER -->
    <div class="rz-p-4 border-bottom">
        <RadzenText TextStyle="TextStyle.H6" Weight="FontWeight.Bold">
            Duyệt kế hoạch biên soạn & Dự toán
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Caption">
            Thẩm định kế hoạch và dự toán từ chủ biên
        </RadzenText>
    </div>

    <RadzenRow Class="rz-m-0">

        <!-- LEFT -->
        <RadzenColumn Size="12" SizeMD="4" Class="rz-p-3 border-end" Style="background:#fafafa">
            <RadzenStack Gap="12px">
                @foreach (var item in lstGTTL)
                {
                    <div class="left-item @(selectedGTTL?.IdGTTL == item.IdGTTL ? "active" : "")"
                         @onclick="() => OnSelect(item)">
                        <RadzenText Weight="FontWeight.Bold">@item.TenGTTL</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">Chủ biên: @item.ChuBien</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">Nộp: @item.NgayGiaoNV?.ToString("dd/MM/yyyy")</RadzenText>

                        <RadzenBadge Text="Chờ thẩm định"
                                     BadgeStyle="BadgeStyle.Warning"
                                     IsPill="true"
                                     Class="rz-mt-2" />
                    </div>
                }
            </RadzenStack>
        </RadzenColumn>

        <!-- RIGHT -->
        <RadzenColumn Size="12" SizeMD="8" Class="rz-p-4">
            @if (selectedGTTL != null)
            {
                <RadzenTabs>

                    <!-- TAB KẾ HOẠCH -->
                    <RadzenTabsItem Text="Kế hoạch" Icon="event">

                        <RadzenText Weight="FontWeight.Bold" Class="rz-mb-3">
                            Thông tin kế hoạch
                        </RadzenText>

                        <RadzenRow Class="rz-mb-4">
                            <RadzenColumn Size="6">
                                <RadzenText TextStyle="TextStyle.Caption">Ngày bắt đầu</RadzenText>
                                <RadzenText Weight="FontWeight.Bold">
                                    @selectedKeHoach?.NgayBatDau?.ToString("dd/MM/yyyy")
                                </RadzenText>
                            </RadzenColumn>

                            <RadzenColumn Size="6">
                                <RadzenText TextStyle="TextStyle.Caption">Ngày kết thúc</RadzenText>
                                <RadzenText Weight="FontWeight.Bold">
                                    @selectedKeHoach?.NgayDuKienHoanThanh?.ToString("dd/MM/yyyy")
                                </RadzenText>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenText Weight="FontWeight.Bold" Class="rz-mb-2">
                            Các mốc thời gian
                        </RadzenText>
                        @foreach(var cv in lstCongViec)
                        {
                            <div class="timeline-item">
                                <div class="timeline-index">@(lstCongViec.IndexOf(cv)+1)</div>
                                <div class="flex-grow-1">@cv?.tenMocCongViec</div>
                                <small>@cv?.ngayDuKien</small>
                            </div>
                        }

                        @* <div class="timeline-item">
                            <div class="timeline-index">1</div>
                            <div class="flex-grow-1">Hoàn thành đề cương chi tiết</div>
                            <small>@selectedKeHoach?.HanDeCuong?.ToString("dd/MM/yyyy")</small>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-index">2</div>
                            <div class="flex-grow-1">Hội thảo</div>
                            <small>@selectedKeHoach?.HanHoiThao?.ToString("dd/MM/yyyy")</small>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-index">3</div>
                            <div class="flex-grow-1">Hoàn thành bản thảo</div>
                            <small>@selectedKeHoach?.ba?.ToString("dd/MM/yyyy")</small>
                        </div> *@

                        <RadzenText Weight="FontWeight.Bold" Class="rz-mt-4">
                            File đề cương chi tiết
                        </RadzenText>

                        <div class="upload-box rz-mt-2">
                            <RadzenLink Icon="description" Path="#">
                                @selectedKeHoach?.FileDeCuongChiTiet
                            </RadzenLink>
                        </div>

                        <RadzenText Weight="FontWeight.Bold" Class="rz-mt-4">
                            Nhận xét QLKH
                        </RadzenText>

                        <RadzenTextArea @bind-Value="selectedKeHoach.NhanXet"
                                        Style="width:100%"
                                        Rows="3"
                                        Placeholder="Nhập nhận xét kế hoạch..." />
                    </RadzenTabsItem>

                    <!-- TAB DỰ TOÁN -->
                    <RadzenTabsItem Text="Dự toán" Icon="payments">
                        <RadzenStack Gap="8px" Class="rz-mt-4">
                            <RadzenText>Thù lao viết: <b>@selectedDuToan?.thuLaoViet?.ToString("N0") đ</b></RadzenText>
                            <RadzenText>Chi phí hội thảo: <b>@selectedDuToan?.chiPhiHoiThao?.ToString("N0") đ</b></RadzenText>
                            <RadzenText>Chi phí thẩm định: <b>@selectedDuToan?.chiPhiThamDinh?.ToString("N0") đ</b></RadzenText>
                            <RadzenText>Chi phí in ấn: <b>@selectedDuToan?.chiPhiInAn?.ToString("N0") đ</b></RadzenText>

                            <hr />
                            <RadzenText Weight="FontWeight.Bold">
                                Tổng cộng: @TinhTongCong(selectedDuToan)?.ToString("N0") đ
                            </RadzenText>
                        </RadzenStack>
                    </RadzenTabsItem>

                </RadzenTabs>

                <!-- ACTION -->
                <RadzenStack Orientation="Orientation.Horizontal"
                             JustifyContent="JustifyContent.End"
                             Gap="12px"
                             Class="rz-mt-4">
                    <RadzenButton Text="Yêu cầu chỉnh sửa"
                                  ButtonStyle="ButtonStyle.Light" />
                    <RadzenButton Text="Hoàn tất thẩm định"
                                  ButtonStyle="ButtonStyle.Success" />
                </RadzenStack>
            }
        </RadzenColumn>
    </RadzenRow>
</RadzenCard>

@code {
    private List<tbGTTL> lstGTTL = new();
    private tbGTTL? selectedGTTL;
    private tbKeHoach? selectedKeHoach;
    private tbDuToan? selectedDuToan;
    private List<tbCacMocCongViec>? lstCongViec;

    protected override async Task OnInitializedAsync()
    {
        lstGTTL = await apiService.GetAll<tbGTTL>();
        // lstCongViec = await apiService.GetAll<tbCacMocCongViec>();
    }

    async Task OnSelect(tbGTTL item)
    {
        selectedGTTL = item;

        selectedKeHoach = (await apiService.GetAll<tbKeHoach>())
            .FirstOrDefault(x => x.IdKeHoachBienSoan == item.IdGTTL);

        selectedDuToan = (await apiService.GetAll<tbDuToan>())
            .FirstOrDefault(x => x.idDuToan == item.IdGTTL);
    }

    long? TinhTongCong(tbDuToan duToan)
    {
        if (duToan == null) return 0;
        return (duToan.thuLaoViet ?? 0)
             + (duToan.chiPhiHoiThao ?? 0)
             + (duToan.chiPhiThamDinh ?? 0)
             + (duToan.chiPhiInAn ?? 0);
    }
}
