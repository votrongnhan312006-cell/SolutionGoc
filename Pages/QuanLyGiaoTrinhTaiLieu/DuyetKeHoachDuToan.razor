@page "/DuyetKeHoachDuToan"
@using Radzen
@using Radzen.Blazor
@using QLCongViec.Models
@using api.Models.QLBienSoan
@inject DialogService DialogService

<RadzenCard Style="margin: 20px; padding: 0px; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
    <div style="padding: 15px 20px; border-bottom: 1px solid #eee; background-color: #fcfcfc;">
        <h5 style="margin: 0; font-weight: bold; color: #2c3e50;">Duyệt kế hoạch biên soạn & Dự toán</h5>
        <small class="text-muted">Thẩm định kế hoạch và dự toán từ chủ biên</small>
    </div>

    <div class="row g-0">
        <div class="col-md-4" style="border-right: 1px solid #eee; background-color: #fafafa; min-height: 75vh;">
            <RadzenListBox TValue="tbKeHoach" Data="@lstKeHoach" @bind-Value="selectedKeHoach"
                           Style="width: 100%; height: 100%; border: none; background: transparent;">
                <Template Context="item">
                    <div style="padding: 10px 5px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong style="color: #115599; font-size: 14px;">@item.ngayBatDau?.ToString("dd/MM/yyyy")</strong>
                            <span style="font-size: 10px; background: #fff8e1; color: #fbc02d; padding: 2px 6px; border-radius: 4px; border: 1px solid #ffe082;">Chờ thẩm định</span>
                        </div>
                        <div style="font-size: 12px; margin-top: 4px;">
                            <div class="fw-bold text-dark">Kế hoạch biên soạn</div>
                            <div class="text-muted">@item.idKeHoachBienSoan</div>
                            <div class="text-muted mt-1">
                                Bắt đầu: @item.ngayBatDau?.ToString("dd/MM/yyyy") | Kết thúc: @item.ngayDuKienHoanThanh?.ToString("dd/MM/yyyy")
                            </div>
                        </div>
                    </div>
                </Template>
            </RadzenListBox>
        </div>

        <div class="col-md-8" style="padding: 25px; background-color: #fff;">
            @if (selectedKeHoach != null)
            {
                <RadzenTabs TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client">
                    <Tabs>
                        <RadzenTabsItem Text="Kế hoạch" Icon="event">
                            <div style="padding-top: 20px;">
                                <h6 style="font-weight: bold; color: #555;">Thông tin kế hoạch</h6>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="text-muted d-block" style="font-size: 11px; text-transform: uppercase;">Ngày bắt đầu</label>
                                        <div class="fw-bold">@selectedKeHoach.ngayBatDau?.ToString("dd/MM/yyyy")</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="text-muted d-block" style="font-size: 11px; text-transform: uppercase;">Ngày kết thúc</label>
                                        <div class="fw-bold">@selectedKeHoach.ngayDuKienHoanThanh?.ToString("dd/MM/yyyy")</div>
                                    </div>
                                </div>

                                <h6 style="font-weight: bold; color: #555;">File đề cương chi tiết</h6>
                                <div class="mt-4 p-3" style="border: 1px dashed #ddd; border-radius: 8px; background: #fafafa;">
                                    <label class="text-muted d-block mb-1" style="font-size: 11px;">FILE ĐỀ CƯƠNG CHI TIẾT</label>
                                    @if (!string.IsNullOrEmpty(selectedKeHoach.fileDeCuongChiTiet))
                                    {
                                        <RadzenLink Path="#" Text="@selectedKeHoach.fileDeCuongChiTiet" Icon="picture_as_pdf" Style="font-weight: 500;" />
                                    }
                                    else
                                    {
                                        <span class="text-muted">Chưa có file</span>
                                    }
                                </div>
                            </div>
                        </RadzenTabsItem>

                        <RadzenTabsItem Text="Dự toán" Icon="payments">
                            <div style="padding-top: 20px;">
                                <h6 style="font-weight: bold; color: #555; margin-bottom: 15px;">Chi tiết kinh phí</h6>
                                <div class="p-3 border rounded">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Thù lao viết</span>
                                        <strong>@selectedDuToan?.thuLaoViet?.ToString("N0") đ</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Chi phí hội thảo</span>
                                        <strong>@selectedDuToan?.chiPhiHoiThao?.ToString("N0") đ</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Chi phí thẩm định</span>
                                        <strong>@selectedDuToan?.chiPhiThamDinh?.ToString("N0") đ</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span>Chi phí in ấn</span>
                                        <strong>@selectedDuToan?.chiPhiInAn?.ToString("N0") đ</strong>
                                    </div>
                                    <hr />
                                    <div class="d-flex justify-content-between mt-2" style="color: #d32f2f; font-size: 18px; font-weight: bold;">
                                        <span>TỔNG CỘNG</span>
                                        <span>@TinhTongCong()?.ToString("N0") đ</span>
                                    </div>
                                </div>
                            </div>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>

                <div style="margin-top: 30px; border-top: 2px solid #f5f5f5; padding-top: 20px;">
                    <label class="fw-bold mb-2" style="font-size: 13px;">Nhận xét QLKH</label>
                    <RadzenTextArea @bind-Value="selectedKeHoach.nhanXet"
                                    Placeholder="Nhập nội dung góp ý hoặc lý do từ chối..."
                                    Style="width: 100%; height: 80px;" />

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <RadzenButton Text="Yêu cầu chỉnh sửa" ButtonStyle="ButtonStyle.Light" Icon="history_edu"
                                      Click="@(() => OnYeuCauChinhSua())" />
                        <RadzenButton Text="Duyệt kế hoạch" ButtonStyle="ButtonStyle.Success" Icon="task_alt"
                                      Click="@(() => OnDuyetKeHoach())" />
                    </div>
                </div>
            }
        </div>
    </div>
</RadzenCard>

@code {
    private List<tbKeHoach>? lstKeHoach = new();
    private List<tbDuToan>? lstDuToan = new();
    private tbKeHoach? selectedKeHoach;
    private tbDuToan? selectedDuToan;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        // TODO: Gọi API để load dữ liệu
        // await LoadKeHoachList();
        // await LoadDuToanList();
    }

    private void OnSelectionChanged(tbKeHoach keHoach)
    {
        selectedKeHoach = keHoach;
        // TODO: Load dự toán tương ứng với kế hoạch được chọn
        // selectedDuToan = lstDuToan?.FirstOrDefault(x => x.idDuToan == keHoach.id);
    }

    private long? TinhTongCong()
    {
        if (selectedDuToan == null) return 0;
        return (selectedDuToan.thuLaoViet ?? 0) +
               (selectedDuToan.chiPhiHoiThao ?? 0) +
               (selectedDuToan.chiPhiThamDinh ?? 0) +
               (selectedDuToan.chiPhiInAn ?? 0);
    }

    private async Task OnYeuCauChinhSua()
    {
        if (selectedKeHoach == null) return;
        // TODO: Cập nhật trạng thái và lưu nhận xét
        Console.WriteLine($"Yêu cầu chỉnh sửa: {selectedKeHoach.nhanXet}");
    }

    private async Task OnDuyetKeHoach()
    {
        if (selectedKeHoach == null) return;
        // TODO: Duyệt kế hoạch và lưu vào database
        Console.WriteLine($"Duyệt kế hoạch: {selectedKeHoach.idKeHoachBienSoan}");
    }
}
