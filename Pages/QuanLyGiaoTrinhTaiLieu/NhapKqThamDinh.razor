@page "/ThamDinhGt"
@using Radzen
@using Radzen.Blazor
@using api.Models.QLBienSoan
@inject DialogService DialogService

<style>
    /* Style cho danh sách đề tài bên trái */
    .item-card {
        border: 1px solid #ddd;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 8px;
    }

        .item-card:hover {
            background-color: #f8f9fa;
        }

    .item-card-selected {
        border: 2px solid #4A90E2 !important;
        background-color: #f0f7ff !important;
    }

    /* Style cho vùng Upload file giống Mockup */
    .custom-upload-box .rz-fileupload-buttonbar {
        display: none !important;
    }

    .custom-upload-box .rz-fileupload-content {
        border: 2px dashed #ccc !important;
        border-radius: 8px !important;
        background: #fafafa !important;
        cursor: pointer;
        padding: 20px !important;
    }

        .custom-upload-box .rz-fileupload-content:hover {
            border-color: #4A90E2 !important;
            background: #f0f7ff !important;
        }

    /* Tùy chỉnh danh sách kết luận */
    .conclusion-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        width: 100%;
        display: flex;
        align-items: center;
    }
</style>

<div class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Weight="FontWeight.Bold">Quản lý thẩm định nội dung</RadzenText>
    <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-mb-6">Cập nhật kết quả thẩm định từ Hội đồng</RadzenText>

    <RadzenRow Gap="1.5rem">
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenStack Gap="12px">
                @foreach (var item in lstGTTL)
                {
                    <RadzenCard @onclick="@(() => selectedGTTL = item)"
                                Class="@(selectedGTTL?.IdGTTL == item.IdGTTL ? "item-card item-card-selected rz-p-3" : "item-card rz-p-3")">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Start">
                            <RadzenStack Gap="4px" Style="width: 75%;">
                                <RadzenText TextStyle="TextStyle.Subtitle2" Weight="FontWeight.Bold" Class="rz-mb-0">@item.TenGTTL
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-mb-0">Chủ biên: @item.ChuBien</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" Class="rz-mb-0">Đơn vị: @lstDonVi?.FirstOrDefault(x => x.IdDonVi == item.IdDonVi)?.DonVi</RadzenText>
                                @* <RadzenText TextStyle="TextStyle.Caption">Nộp: @item.NgayGuiDeXuat?.ToString("dd/MM/yyyy")</RadzenText> *@
                            </RadzenStack>
                            <RadzenBadge BadgeStyle="@GetBadgeStyle(Convert.ToByte(item.IdTinhTrang))" Text="@GetTrangThai(Convert.ToByte(item.IdTinhTrang))" IsPill="true" />
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="8">
            @if (selectedGTTL != null)
            {
                <RadzenCard Variant="Variant.Outlined" Class="rz-p-5">
                    <RadzenText TextStyle="TextStyle.H6" Weight="FontWeight.Bold">Thông tin đề tài</RadzenText>
                    <hr class="rz-mb-4" />

                    <RadzenRow Class="rz-mb-6">
                        <RadzenColumn Size="6">
                            @* <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Mã tài liệu</RadzenText>
                            <RadzenText Class="rz-mb-4">@selectedGTTL.MaTaiLieu</RadzenText> *@

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Tên giáo trình/tài liệu</RadzenText>
                            <RadzenText Class="rz-mb-4">@selectedGTTL.TenGTTL</RadzenText>

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Đơn vị</RadzenText>
                            <RadzenText>@lstDonVi?.FirstOrDefault(x => x.IdDonVi == selectedGTTL.IdDonVi)?.DonVi</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Trạng thái</RadzenText>
                            <RadzenBadge BadgeStyle="@GetBadgeStyle(Convert.ToByte(selectedGTTL.IdTinhTrang))" Text="@GetTrangThai(Convert.ToByte(selectedGTTL.IdTinhTrang))" Class="rz-mb-4" />

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Chủ biên</RadzenText>
                            <RadzenText Class="rz-mb-4">@selectedGTTL.ChuBien</RadzenText>

                            <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Ngày thẩm định</RadzenText>
                            <RadzenText>@selectedGTTL.NgayThamDinh?.ToString("dd/MM/yyyy")</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>

                    <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Bản thảo</RadzenText>
                    <RadzenStack Orientation="Orientation.Vertical" Gap="8px" Class="rz-mb-6">
                        @if (!string.IsNullOrEmpty(selectedGTTL.FileBanThao))
                        {
                            <RadzenLink Path="#" Icon="description">@selectedGTTL.FileBanThao</RadzenLink>
                        }
                        @if (!string.IsNullOrEmpty(selectedGTTL.FileDeCuongChiTiet))
                        {
                            <RadzenLink Path="#" Icon="description">@selectedGTTL.FileDeCuongChiTiet</RadzenLink>
                        }
                        @if (string.IsNullOrEmpty(selectedGTTL.FileBanThao) && string.IsNullOrEmpty(selectedGTTL.FileDeCuongChiTiet))
                        {
                            <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">Chưa có file bản thảo</RadzenText>
                        }
                    </RadzenStack>

                    <RadzenText TextStyle="TextStyle.Caption" Weight="FontWeight.Bold">Hội đồng thẩm định</RadzenText>

                    @if (selectedGTTL.IdTinhTrang == 3)
                    {
                        <RadzenAlert Title="Kết quả thẩm định" AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true">
                            <RadzenText TextStyle="TextStyle.Body2"><b>@GetTrangThai(Convert.ToByte(selectedGTTL.IdTinhTrang))</b> - Ngày thẩm định: @selectedGTTL.NgayThamDinh?.ToString("dd/MM/yyyy")</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@(string.IsNullOrEmpty(selectedGTTL.GhiChu) ? "Nội dung đầy đủ, cấu trúc logic, đạt yêu cầu đề ra." : selectedGTTL.GhiChu)</RadzenText>
                        </RadzenAlert>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter" ShowIcon="true" Class="rz-mb-4">
                            Sau khi Hội đồng họp xong, vui lòng nhập kết quả thẩm định và đính kèm biên bản.
                        </RadzenAlert>
                        <RadzenButton Text="Nhập kết quả thẩm định" Icon="edit"
                                      ButtonStyle="ButtonStyle.Primary" Class="rz-w-100 rz-mt-2"
                                      Style="height: 45px; font-size: 16px;"
                                      Click="@ShowInputResultDialog" />
                    }
                </RadzenCard>
            }
        </RadzenColumn>
    </RadzenRow>
</div>

@inject ApiServices apiService
@code {
    private List<tbGTTL> lstGTTL = new();
    private tbGTTL? selectedGTTL = new();
    private tbKetQuaThamDinhNoiDung kqThamDinh = new();
    private List<tbDonVi> lstDonVi = new();

    protected override async Task OnInitializedAsync()
    {
        lstDonVi = await apiService.GetAll<tbDonVi>();
        lstGTTL = await apiService.GetAll<tbGTTL>();
    }

    BadgeStyle GetBadgeStyle(byte status) => status switch
    {
        1 => BadgeStyle.Warning,
        2 => BadgeStyle.Info,
        3 => BadgeStyle.Success,
        4 => BadgeStyle.Danger,
        5 => BadgeStyle.Secondary,
        _ => BadgeStyle.Secondary
    };

    string GetTrangThai(byte status) => status switch
    {
        1 => "Chờ thẩm định",
        2 => "Đang thẩm định",
        3 => "Đạt",
        4 => "Không đạt",
        5 => "Cần chỉnh sửa",
        _ => "Không xác định"
    };

    async Task ShowInputResultDialog()
    {
        await DialogService.OpenAsync<NhapKqThamDinh_Dialog>(
        "Cập nhật kết quả",
        new Dictionary<string, object>
        {
            { "selectedGTTL", selectedGTTL },
        },
        new DialogOptions
        {
            Width = "580px",
            Resizable = false,
            Draggable = true
        }
    );
    }
}
