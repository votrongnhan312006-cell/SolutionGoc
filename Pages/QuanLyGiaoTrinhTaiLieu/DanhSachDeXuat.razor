@page "/danhsachdexuatgt"
@using Radzen
@using Radzen.Blazor
@using api.Models.QLBienSoan
@inject DialogService DialogService




<RadzenCard Style="padding:20px">

    <h4 style="font-weight:600">Danh sách đề xuất của đơn vị</h4>
    <p style="color:#6c757d">
        Theo dõi trạng thái các đề xuất biên soạn đã gửi
    </p>
    <RadzenDataGrid Data="@lstGTTL"
                    TItem="tbGTTL"
                    AllowPaging="true"
                    PageSize="5"
                    ShowPagingSummary="false">

         <Columns> 

            <!-- STT -->
            <RadzenDataGridColumn Title="STT" Width="60px">
                <Template Context="ctx">
                    @(lstGTTL.IndexOf(ctx) + 1)
                </Template>
            </RadzenDataGridColumn>

            <!-- TÊN TÀI LIỆU -->
            <RadzenDataGridColumn Title="Tên tài liệu">
                <Template Context="ctx">
                        @ctx.TenGTTL
                    @if (!string.IsNullOrEmpty(ctx.GhiChu))
                    {
                        <div style="font-size:12px;color:#6c757d">
                            @ctx.GhiChu
                        </div>
                    }
                </Template>
            </RadzenDataGridColumn>

            <!-- LOẠI HÌNH -->
            <RadzenDataGridColumn Title="Loại hình" >
                <Template Context="ctx">
                    @lstLoaiHinh?.FirstOrDefault(x => x.IdNhomLoaiGTTL == ctx.IdNhomLoaiGTTL)?.LoaiGTTL
                </Template>
            </RadzenDataGridColumn>

            <!-- CHỦ BIÊN -->
            <RadzenDataGridColumn Property="ChuBien" Title="Chủ biên" />

            <!-- NGÀY GỬI -->
             <RadzenDataGridColumn Title="Bậc học sử dụng">
                <Template Context="ctx">
                    @lstBacHoc?.FirstOrDefault(x => x.IdBacHocSuDungGTTL == ctx.IdBacHocSuDungGTTL)?.BacHocSuDungGTTL
                </Template>
            </RadzenDataGridColumn> 

            <!-- TRẠNG THÁI -->
            <RadzenDataGridColumn Title="Trạng thái">
                <Template Context="item">
                    @TrangThaiBadge(Convert.ToByte(item.IdTinhTrang))

                </Template>
            </RadzenDataGridColumn>

            <!-- THAO TÁC -->
            <RadzenDataGridColumn Title="Thao tác" Width="190px">
                <Template Context="item">
                    <RadzenStack Orientation="Orientation.Horizontal"
                                 JustifyContent="JustifyContent.End"
                                 Gap="1rem">

                        <RadzenButton Text="Chi tiết đề tài"
                                      Icon="send"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Style="min-width:90px"
                                      Click="@(args => MoChiTietDeTai(item))" />

                        <RadzenButton Text="Xét duyệt"
                                      Icon="send"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Style="min-width:90px"
                                      Click="@(args => MoChiTiet(item))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>


         </Columns> 
    </RadzenDataGrid>
</RadzenCard>

@inject ApiServices apiService
@code {

    private List<tbGTTL> lstGTTL = new();
    private tbGTTL? selectedItem;

    //Lấy data từ các danh mục
    private List<tbNhomLoaiGTTL> lstLoaiHinh = new();
    private List<tbBacHocSuDungGTTL> lstBacHoc = new();

    protected override async Task OnInitializedAsync()
    {
        lstGTTL = await apiService.GetAll<tbGTTL>();
        lstLoaiHinh = await apiService.GetAll<tbNhomLoaiGTTL>();
        lstBacHoc = await apiService.GetAll<tbBacHocSuDungGTTL>();
    }

    async Task MoChiTietDeTai(tbGTTL item)
    {
        await DialogService.OpenAsync<ChiTietDeTai_Dialog>(
            "",
            new Dictionary<string, object>
            {
                { "Model", item }
            },
            new DialogOptions
            {
                Width = "800px",
                Height = "85vh",
                ShowTitle = false
            });
    }

    // ====== POPUP CHI TIẾT ĐỀ XUẤT ======
    async Task MoChiTiet(tbGTTL item)
    {
        await DialogService.OpenAsync<ChiTietDeXuat_Dialog>(
            "",
            new Dictionary<string, object>
            {
                { "SelectedGTTL", item }
            },
            new DialogOptions
            {
                Width = "600px",
                Height = "80vh",
                ShowTitle = false
            });
    }

    // ====== BADGE TRẠNG THÁI ======
    RenderFragment TrangThaiBadge(byte tinhTrang) => builder =>
    {
        var (text, color) = tinhTrang switch
        {
            1 => ("Được phê duyệt", "#d1f7dc"),
            0 => ("Chờ xét duyệt", "#fff3cd"),
            _ => ("Không phê duyệt", "#f8d7da")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "style",
            $"padding:5px 10px;border-radius:16px;background:{color}");
        builder.AddContent(2, text);
        builder.CloseElement();
    };
}