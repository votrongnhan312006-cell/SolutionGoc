@page "/DanhSachDeXuatGt"
@using QLCongViec.Models.QLBienSoan
@using Radzen
@using Radzen.Blazor
@using api.Models.QLBienSoan
@inject DialogService DialogService

<style>
    .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
    }

        /* Được phê duyệt */
        .status-pill.approved {
            background-color: #e6f7ec;
            color: #198754;
        }

        /* Chờ xét duyệt */
        .status-pill.pending {
            background-color: #fff4e5;
            color: #d39e00;
        }

        /* Không phê duyệt */
        .status-pill.rejected {
            background-color: #fdecea;
            color: #dc3545;
        }

        /* Icon Radzen */
        .status-pill .rz-icon {
            font-size: 16px;
        }

</style>


<RadzenCard Style="padding:20px">

    <h4 style="font-weight:600">Danh sách đề xuất của đơn vị</h4>
    <p style="color:#6c757d">
        Theo dõi trạng thái các đề xuất biên soạn đã gửi
    </p>
    <RadzenDataGrid Data="@lstGTTL"
                    TItem="tbGTTL"
                    AllowPaging="true"
                    PageSize="5"
                    ShowPagingSummary="false">

        <Columns>

            <!-- STT -->
            <RadzenDataGridColumn Title="STT" Width="60px">
                <Template Context="ctx">
                    @(lstGTTL.IndexOf(ctx) + 1)
                </Template>
            </RadzenDataGridColumn>

            <!-- TÊN TÀI LIỆU -->
            <RadzenDataGridColumn Title="Tên tài liệu" Width="170px">
                <Template Context="ctx">
                    @ctx.TenGTTL
                    @if (!string.IsNullOrEmpty(ctx.GhiChu))
                    {
                        <div style="font-size:12px;color:#6c757d">
                            @ctx.GhiChu
                        </div>
                    }
                </Template>
            </RadzenDataGridColumn>


            <!-- LOẠI HÌNH -->
            <RadzenDataGridColumn Title="Loại hình" Width="120px">
                <Template Context="ctx">
                    @lstLoaiHinh?.FirstOrDefault(x => x.IdNhomLoaiGTTL == ctx.IdNhomLoaiGTTL)?.LoaiGTTL
                </Template>
            </RadzenDataGridColumn>


            <!-- CHỦ BIÊN -->
            <RadzenDataGridColumn Property="ChuBien" Title="Chủ biên" Width="120px" TextAlign="TextAlign.Left" />


            <!-- BẬC HỌC SỬ DỤNG -->
            <RadzenDataGridColumn Title="Bậc học sử dụng" Width="100px" TextAlign="TextAlign.Left">
                <Template Context="ctx">
                    @lstBacHoc?.FirstOrDefault(x => x.IdBacHocSuDungGTTL == ctx.IdBacHocSuDungGTTL)?.BacHocSuDungGTTL
                </Template>
            </RadzenDataGridColumn>



            <!-- TRẠNG THÁI -->
            <RadzenDataGridColumn Title="Trạng thái" Width="220px" TextAlign="TextAlign.Center">
                <Template Context="ctx">
                    @if (ctx.IdTinhTrang == 0)
                    {
                        <span class="status-pill pending">
                            <i class="rz-icon rz-clock"></i>
                            <i class="bx bx-pie-chart"></i>Chờ xét duyệt
                        </span>
                    }
                    @if (ctx.IdTinhTrang == 1)
                    {
                        <span class="status-pill approved">
                            <i class="rz-icon rz-check-circle"></i>
                            <i class="bx bx-check-double"></i>Được phê duyệt
                        </span>
                    }
                    @if (ctx.IdTinhTrang == 2)
                    {
                        <span class="status-pill rejected">
                            <i class="rz-icon rz-close-circle"></i>
                            <i class="bx bx-x-circle"></i>Không được phê duyệt
                        </span>
                    }
                </Template>
            </RadzenDataGridColumn>



            <!-- THAO TÁC -->
            <RadzenDataGridColumn Title="Thao tác" Width="190px" TextAlign="TextAlign.Center">
                <Template Context="ctx">
                    <RadzenStack Orientation="Orientation.Vertical"
                                 AlignItems="AlignItems.Center"
                                 Gap="6px"
                                 Style="padding-top:6px;padding-bottom:6px">

                        <RadzenButton Text="Chi tiết"
                                      Icon="info"
                                      ButtonStyle="ButtonStyle.Light"
                                      Class="rz-shadow-sm"
                                      Style="width:150px;height:40px;border-radius:6px;text-align:center;justify-content:center"
                                      Click="@(args => MoChiTietDeTai(ctx))" />

                        @if (ctx.IdTinhTrang == 0)
                        {
                            <RadzenButton Text="Xét duyệt"
                                          Icon="check"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Class="rz-shadow-sm"
                                          Style="width:150px;height:40px;border-radius:6px;text-align:center;justify-content:center"
                                          Click="@(args => XetDuyet(ctx))" />
                        }
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>


        </Columns>
    </RadzenDataGrid>
</RadzenCard>

@inject ApiServices apiService
@code {

    private List<tbGTTL> lstGTTL = new();
    private tbGTTL? selectedItem;

    //Lấy data từ các danh mục
    private List<tbNhomLoaiGTTL> lstLoaiHinh = new();
    private List<tbBacHocSuDungGTTL> lstBacHoc = new();
    private List<tbTrangThai> lstTrangThai = new();

    protected override async Task OnInitializedAsync()
    {
        lstGTTL = await apiService.GetAll<tbGTTL>();
        lstLoaiHinh = await apiService.GetAll<tbNhomLoaiGTTL>();
        lstBacHoc = await apiService.GetAll<tbBacHocSuDungGTTL>();
        lstTrangThai = await apiService.GetAll<tbTrangThai>();
    }

    async Task MoChiTietDeTai(tbGTTL item)
    {
        await DialogService.OpenAsync<ChiTietDeTai_Dialog>(
            "",
            new Dictionary<string, object>
            {
                { "Model", item }
            },
            new DialogOptions
            {
                Width = "800px",
                Height = "85vh",
                ShowTitle = false
            });
    }

    // ====== POPUP CHI TIẾT ĐỀ XUẤT ======
    async Task XetDuyet(tbGTTL item)
    {
        await DialogService.OpenAsync<XetDuyetDeTai_Dialog>(
            "",
            new Dictionary<string, object>
            {
                { "SelectedGTTL", item }
            },
            new DialogOptions
            {
                Width = "600px",
                Height = "80vh",
                ShowTitle = false
            });
    }

    // ====== BADGE TRẠNG THÁI ======
    RenderFragment TrangThaiBadge(byte tinhTrang) => builder =>
    {
        var (text, color) = tinhTrang switch
        {
            1 => ("Được phê duyệt", "#d1f7dc"),
            0 => ("Chờ xét duyệt", "#fff3cd"),
            _ => ("Không phê duyệt", "#f8d7da")
        };

        builder.OpenElement(0, "span");
        builder.AddAttribute(1, "style",
            $"padding:5px 10px;border-radius:16px;background:{color}");
        builder.AddContent(2, text);
        builder.CloseElement();
    };
}