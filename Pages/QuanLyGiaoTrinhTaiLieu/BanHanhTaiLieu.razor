@page "/BanHanhGTTL"
@using QLCongViec.Models
@using api.Models.QLBienSoan
@inject DialogService DialogService
@inject ApiServices apiService

<div class="rz-p-4">
    <RadzenText TextStyle="TextStyle.H5" Weight="FontWeight.Bold">Ban hành giáo trình, tài liệu</RadzenText>
    <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-mb-6">Quản lý việc ban hành các thẩm định đạt</RadzenText>

    <div class="row">

        <!-- ================= LEFT ================= -->
        <div class="col-md-4">
            <RadzenCard Class="left-card">
                <div class="document-list mt-3">

                    @if (lstGTTL == null)
                    {
                        <p>Đang tải dữ liệu...</p>
                    }
                    else if (!lstGTTL.Any())
                    {
                        <p>Không có dữ liệu</p>
                    }
                    else
                    {
                        @foreach (var item in lstGTTL)
                        {
                            <div class="doc-item @(selectedItem == item ? "active" : "")"
                                 @onclick="() => SelectItem(item)">

                                <div class="doc-header">
                                    <strong>@item.TenGTTL</strong>

                                    <!-- ✅ SỬA: dùng item, KHÔNG dùng selectedItem -->
                                    <RadzenBadge Text="@(item.IdTinhTrang == 1 ? "Chờ ban hành" : "Đã ban hành")"
                                                 Style="@(item.IdTinhTrang == 1
                                                                                                                                                  ? "background:#FFE8CC;color:#9A4D00"
                                                                                                                                                  : "background:#E6F4EA;color:#1E7F43")" />
                        </div>

                                <div class="doc-meta">
                                    <div>@item.ChuBien</div>
                                    <div>@item.IdDonVi</div>
                                    <div>Thẩm định: @item.NgayThamDinh?.ToString("dd/MM/yyyy")</div>
                                </div>
                            </div>
                                        }
                    }

                </div>
            </RadzenCard>
        </div>

        <!-- ================= RIGHT ================= -->
        <div class="col-md-8">

            @if (selectedItem != null)
            {
                <RadzenCard Class="right-card">

                    <h4>Thông tin tài liệu</h4>
                    <hr />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <label>Mã tài liệu</label>
                                <span>@selectedItem.MaTaiLieu</span>
                            </div>

                            <div class="info-item">
                                <label>Tên tài liệu</label>
                                <span>@selectedItem.TenGTTL</span>
                            </div>

                            <div class="info-item">
                                <label>Đơn vị</label>
                                <span>@selectedItem.IdDonVi</span>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-item">
                                <label>Trạng thái</label>
                                <RadzenBadge Text="@(selectedItem.IdTinhTrang == 1 ? "Chờ ban hành" : "Đã ban hành")"
                                             Style="@(selectedItem.IdTinhTrang == 1
                                                                                                                                      ? "background:#FFE8CC;color:#9A4D00"
                                                                                                                                      : "background:#E6F4EA;color:#1E7F43")" />
                        </div>

                            <div class="info-item">
                                <label>Chủ biên</label>
                                <span>@selectedItem.ChuBien</span>
                            </div>

                            <div class="info-item">
                                <label>Ngày thẩm định</label>
                                <span>@selectedItem.NgayThamDinh?.ToString("dd/MM/yyyy")</span>
                            </div>
                        </div>
                    </div>

                    <hr />

                    <RadzenButton Text="Nhập thông tin ban hành"
                                  Icon="check_circle"
                                  ButtonStyle="ButtonStyle.Success"
                                  Class="w-100"
                                  Click="OpenBanHanhDialog" />
                </RadzenCard>
                        }
            else
            {
                <RadzenCard>
                    <p class="text-muted text-center">Vui lòng chọn tài liệu</p>
                </RadzenCard>
            }

        </div>
    </div>
</div>


<style>
    .left-card {
        padding: 12px;
    }

    .document-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .doc-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
    }

        .doc-item.active {
            background: #f0f6ff;
            border-left: 4px solid #3b82f6;
        }

    .doc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .doc-meta {
        font-size: 13px;
        color: #6b7280;
        margin-top: 6px;
    }

    .right-card {
        padding: 20px;
    }

    .info-item {
        margin-bottom: 12px;
    }

        .info-item label {
            font-size: 13px;
            color: #6b7280;
            display: block;
        }
</style>

@code {
    private List<tbGTTL> lstGTTL = new();
    private tbGTTL? selectedItem;

    protected override async Task OnInitializedAsync()
    {
        lstGTTL = await apiService.GetAll<tbGTTL>();
        StateHasChanged();
    }

    void SelectItem(tbGTTL item)
    {
        selectedItem = item;
    }

    async Task OpenBanHanhDialog()
    {
        var result = await DialogService.OpenAsync<BanHanhTaiLieu_Dialog>(
            "",
            new Dictionary<string, object>
            {
                { "selectedItem", selectedItem }
            },
            new DialogOptions { Width = "700px" });

        if (result is bool ok && ok)
        {
            lstGTTL = await apiService.GetAll<tbGTTL>();
            StateHasChanged();
        }
    }
}
